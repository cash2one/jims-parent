<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jims.phstock.dao.DrugDispDao">

    <sql id="patientBaseVo">
      a.patient_id as patientId,
       b.visit_id as visitId,
       b.dept_code as deptCode,
       b.ward_code as wardCode,
       a.name,
       a.id_no as idNo,
       d.discharge_date_expcted as preDischargeDate,
       a.org_id as orgId
	</sql>

    <sql id="orderDispInfoSql">
        a.org_id as orgId,
       a.patient_id as patientId,
       a.visit_id as visitId,
       a.order_no as orderNo,
       a.order_sub_no as orderSubNo,
       b.item_code as drugCode,
       b.item_spec as drugSpec,
       b.units as drugUnit,
       '' firmId,
       a.last_perform_date_time lastPerformDateTime,
       a.dosage,
       a.dosage_units as dosageUnits,
       a.administration,
       a.start_date_time as startDateTime,
       a.stop_date_time as stopDateTime,
       a.repeat_indicator as repeatIndicator,
       a.order_text as orderText,
       a.frequency,
       a.freq_counter as freqCounter,
       a.freq_interval as freqInterval,
       a.freq_interval_unit as freqIntervalUnit,
       a.freq_detail as freqDetail,
       a.perform_schedule as performSchedule,
       a.order_status as orderStatus
    </sql>

    <select id="findPatsInHospital" resultType="PatientBaseVo">
        select
        <include refid="patientBaseVo"/>
        from pat_master_index a,
        pats_in_hospital b,
        bed_rec c,
        pre_dischged_pats d,
        dept_dict e
        where a.patient_id = b.patient_id
        and b.ward_code = c.ward_code
        and a.patient_id = d.patient_id(+)
        and a.org_id = b.org_id
        and a.org_id = e.org_id
        and c.dept_id = e.id
        and a.org_id = d.org_id(+)
        and c.bed_no in
        <foreach collection="bedNos" open="(" separator="," close=")" item="item" index="index">
            #{item}
        </foreach>
        and b.ward_code=#{wardDeptCode}
        and a.org_id = #{orgId}
        and (a.SETTLED_INDICATOR is null or a.settled_indicator =0)
    </select>

    <select id="findOrdersDispInfos" resultType="OrdersDispInfo">
        SELECT
        <include refid="orderDispInfoSql"/>
        FROM  orders a, orders_costs b
        WHERE a.patient_id = b.patient_id
        and a.visit_id = b.visit_id
        and a.id = b.order_id
        and a.order_code = b.item_code
        and a.patient_id = #{patientId}
        and a.visit_id = #{visitId}
        and a.org_id = #{orgId}
        and (a.order_status='3' or a.order_status='2')
        and ((a.repeat_indicator=0 and a.last_perform_date_time is null) or a.repeat_indicator=1 )
        and (a.drug_billing_attr is null or a.drug_billing_attr=0)
        and (a.order_class='A')

    </select>

</mapper>